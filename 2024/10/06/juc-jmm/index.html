<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Java 内存模型 (JMM) | Hexo</title><meta name="author" content="liujinglong"><meta name="copyright" content="liujinglong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文简要介绍 java memory models，主要包括Java 内存模型，重排序，happens-before原则，volatile和final等语义，并提供相关练习，供读者复习。希望读者能通过本文，对JMM和相关问题有一个基本的，初步的了解。要想更进一步地理解，可以多写代码，并查看参考资料中列出的文章。 问题引入有以下代码，执行new Record().run()后，试给出可能的Recor">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 内存模型 (JMM)">
<meta property="og:url" content="https://jinglong-liu.github.io/2024/10/06/juc-jmm/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="本文简要介绍 java memory models，主要包括Java 内存模型，重排序，happens-before原则，volatile和final等语义，并提供相关练习，供读者复习。希望读者能通过本文，对JMM和相关问题有一个基本的，初步的了解。要想更进一步地理解，可以多写代码，并查看参考资料中列出的文章。 问题引入有以下代码，执行new Record().run()后，试给出可能的Recor">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-10-06T00:50:17.000Z">
<meta property="article:modified_time" content="2024-10-06T07:30:35.432Z">
<meta property="article:author" content="liujinglong">
<meta property="article:tag" content="juc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://jinglong-liu.github.io/2024/10/06/juc-jmm/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.14.0-b2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java 内存模型 (JMM)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-06 15:30:35'
}</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Java 内存模型 (JMM)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-06T00:50:17.000Z" title="发表于 2024-10-06 08:50:17">2024-10-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-06T07:30:35.432Z" title="更新于 2024-10-06 15:30:35">2024-10-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2024/10/06/juc-jmm/" data-flag-title="Java 内存模型 (JMM)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本文简要介绍 java memory models，主要包括Java 内存模型，重排序，happens-before原则，volatile和final等语义，并提供相关练习，供读者复习。希望读者能通过本文，对JMM和相关问题有一个基本的，初步的了解。要想更进一步地理解，可以多写代码，并查看参考资料中列出的文章。</p>
<h1 id="问题引入"><a href="#问题引入" class="headerlink" title="问题引入"></a>问题引入</h1><p>有以下代码，执行<code>new Record().run()</code>后，试给出可能的<code>Record &#123;x, y&#125;</code>可能取值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.ljl.learning.juc.case1;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: spring-learning</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: ljl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2024-09-28 08:00</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Record</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            a = <span class="number">1</span>;</span><br><span class="line">            x = b;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            b = <span class="number">2</span>;</span><br><span class="line">            y = a;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Record&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;x=&quot;</span> + x +</span><br><span class="line">                <span class="string">&quot;, y=&quot;</span> + y +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Record)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Record</span> <span class="variable">record</span> <span class="operator">=</span> (Record) o;</span><br><span class="line">        <span class="keyword">return</span> x == record.x &amp;&amp; y == record.y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个方法中，启动了两个线程，异步执行。而x, y的初始值都为0。<br>所以，显然可能出现下面两者情况</p>
<ul>
<li>Record{x&#x3D;0, y&#x3D;1}</li>
<li>Record{x&#x3D;2, y&#x3D;0}</li>
</ul>
<p>经过少量测试后，发现确实如此。然后你觉得你的代码逻辑严密，再也没有第三种可能了，然后自信地提测了。</p>
<p>一会测试就告诉你冒烟测试就挂了，你敢再耽误我时间，早点打包回家得了。</p>
<p>然后告诉你出现了这样的情况</p>
<ul>
<li>Record{x&#x3D;0, y&#x3D;0}</li>
</ul>
<p>的情况</p>
<p><img src="https://jinglong-liu.github.io/images/juc/jmm/1.png" alt="jmm-1"></p>
<p>你在纸上画了半天，也不明白为什么会出现这种情况，一定是打开方式不对。</p>
<p><img src="https://jinglong-liu.github.io/images/juc/jmm/2.png" alt="jmm-2"></p>
<p>然而这确实发生了。The machine is always right。实际上，这是因为发生了指令的重排序，要搞清楚具体的规则，避免发生类似的问题，就不得不提到内存模型(memory models)相关内容。</p>
<h1 id="memory-model"><a href="#memory-model" class="headerlink" title="memory model"></a>memory model</h1><p>什么是内存模型</p>
<p>先上wikipeadia的解释</p>
<p>词条：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Memory_model_(programming)">Memory model (programming)</a></p>
<ul>
<li><p>A memory model allows a compiler to perform many important optimizations. Compiler optimizations like loop fusion move statements in the program, which can influence the order of read and write operations of potentially shared variables. Changes in the ordering of reads and writes can cause race conditions. Without a memory model, a compiler may not apply such optimizations to multi-threaded programs at all, or it may apply optimizations that are incompatible with multi-threading, leading to bugs.</p>
</li>
<li><p>Modern programming languages like Java therefore implement a memory model. The memory model specifies synchronization barriers that are established via special, well-defined synchronization operations such as acquiring a lock by entering a synchronized block or method. The memory model stipulates that changes to the values of shared variables only need to be made visible to other threads when such a synchronization barrier is reached. Moreover, the entire notion of a race condition is defined over the order of operations with respect to these memory barriers.</p>
</li>
</ul>
<p>概括一下：</p>
<p>内存模型可以看作是一种 <strong>协议规范</strong> ，定义了多线程程序中线程如何共享和访问内存的规则。它的存在是为了在 <strong>性能和一致性之间找到平衡</strong> ，让多线程程序既能正确执行，又能充分发挥硬件的并行性能。</p>
<p>Java 内存模型试图屏蔽各种硬件和操作系统的内存访问差异,以实现让 Java 程序在各种平台下都能达到一致的内存访问效果.</p>
<h2 id="主存与工作内存"><a href="#主存与工作内存" class="headerlink" title="主存与工作内存"></a>主存与工作内存</h2><p>每个线程都有自己的执行空间(即工作内存)，线程执行的时候用到某变量，首先要将变量从主内存拷贝的自己的工作内存空间，然后对变量进行操作：读取，修改，赋值等，这些均在工作内存完成，操作完成后再将变量写回主内存</p>
<p>先复习一下计算机存储系统基本的架构，实际上，JMM也是类似的，但有一定的区别</p>
<p><img src="https://jinglong-liu.github.io/images/juc/jmm/4.png" alt="jmm-4"></p>
<p><img src="https://jinglong-liu.github.io/images/juc/jmm/3.png" alt="jmm-3"></p>
<p>对比<br><img src="https://jinglong-liu.github.io/images/juc/jmm/5.png" alt="jmm-5"></p>
<p><a target="_blank" rel="noopener" href="https://jenkov.com/tutorials/java-concurrency/java-memory-model.html">图片来源</a></p>
<p>JMM的设计分为两部分，一部分是面向我们程序员提供的，也就是happens-before规则，它通俗易懂的向我们程序员阐述了一个强内存模型，我们只要理解 happens-before规则，就可以编写并发安全的程序了。 另一部分是针对JVM实现的，为了尽可能少的对编译器和处理器做约束，从而提高性能，JMM在不影响程序执行结果的前提下对其不做要求，即允许优化重排序。</p>
<h1 id="重排序"><a href="#重排序" class="headerlink" title="重排序"></a>重排序</h1><p>在执行程序时，为了提高性能，编译器和处理器会对指令重排序，分为：</p>
<ul>
<li><p>编译器优化重排序:不影响单线程程序语义时，重排序</p>
</li>
<li><p>指令级并行的重排序：ILP 将多条指令重叠执行。如不存在数据依赖性，处理器可以改变语句对应的机器指令的执行顺序</p>
</li>
<li><p>内存系统重排序：处理器使用缓存和读写缓冲器，这使得加载和存储程序看上去可能是乱序的。</p>
</li>
</ul>
<p>对于编译器重排序，JMM的规则会禁止部分重排序</p>
<ul>
<li>对于处理器重排序（包括内存），JMM的规则，会要求Java编译器生成指令序列时，插入特定类型的内存屏障（Memory Barriers）， 来禁止特定的处理器重排序。</li>
</ul>
<h2 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h2><table>
<thead>
<tr>
<th>指令示例</th>
<th>内存屏障类型</th>
<th>描述</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>Load1; LoadLoad; Load2</code></td>
<td>LoadLoad Barrier</td>
<td>确保Load1数据的装载先于Load2及所有后续装载指令的装载</td>
<td>防止在屏障之前读取的数据延迟到屏障之后读取。</td>
</tr>
<tr>
<td><code>Load1; LoadStore; Store1</code></td>
<td>LoadStore Barrier</td>
<td>确保Load1数据的装载先于Load2及所有后续存储指令的装载</td>
<td>防止在屏障之前的读取操作与屏障之后的写入操作重排序。</td>
</tr>
<tr>
<td><code>Store1; StoreLoad; Load2</code></td>
<td>StoreLoad Barrier</td>
<td>确保store1数据对其他处理器可见，先于Store2及所有后续存储指令的存储</td>
<td>最强的屏障，防止屏障前的写入操作与屏障后的读取操作重排序。</td>
</tr>
<tr>
<td><code>Store1; StoreStore; Store2</code></td>
<td>StoreStore Barrier</td>
<td>确保store1数据对其他处理器可见，先于Load2及所有后续装载指令的状态</td>
<td>防止在屏障之前的写操作与屏障之后的写操作重排序。</td>
</tr>
</tbody></table>
<p>StoreLoad Barrier 最强，有其他三个barrier的效果</p>
<h2 id="重排序规则：as-if-serial"><a href="#重排序规则：as-if-serial" class="headerlink" title="重排序规则：as-if-serial"></a>重排序规则：as-if-serial</h2><p>重排序要求符合as-if-serial规则，其含义为：</p>
<ul>
<li>不管怎么重排序，单线程程序的执行结果不能改变。</li>
</ul>
<p>用简单的例子说明</p>
<p>有一个程序片段如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span>;   <span class="comment">// 1</span></span><br><span class="line">b = <span class="number">2</span>;   <span class="comment">// 2</span></span><br><span class="line">x = a;   <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>我们可以发现，语句3涉及变量a的读取，而语句1涉及变量a的写入。而按照程序员的视角，三条语句以1-2-3的顺序执行。那么，如果编译器或者处理器，要对这三条语句进行重排序，单线程下，交换语句1，2的执行顺序，或者2，3的执行顺序，<strong>最终结果一致</strong> ,因此是允许的；而交换1，3语句后，结果不一致，因此是不饮絮的。因此，允许的重排序为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1-2-3</span><br><span class="line">2-1-3</span><br><span class="line">2-3-1</span><br></pre></td></tr></table></figure>

<p>因此，单线程下，程序员不需要顾及太多，就 <strong>看作</strong> 程序会按照编写的顺序，一条一条执行即可。但涉及多个读写操作同一个变量，则不一定能保证。JMM遵循Happens-before规则，利用上述的内存屏障，对重排序作限制。</p>
<p>实际上，程序员关心的是执行的结果（语义），不关心执行的细节，底层实现。因此，JMM的规则，也是为了保证语义不被改变。</p>
<h1 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h1><p>JMM通过happens-before关系，向程序员提供跨线程的内存可见性保证。</p>
<p>A线程的写操作a，与B线程的读操作b之间，存在happens-before关系，则a操作将对B可见</p>
<p>happening-before 概念的出处和定义：<br><a target="_blank" rel="noopener" href="https://dl.acm.org/doi/pdf/10.1145/359545.359563">https://dl.acm.org/doi/pdf/10.1145/359545.359563</a></p>
<p>可以阅读该论文，更加深入地了解happend-before的概念</p>
<p>JSR-133中对<code>happens-before</code>关系定义如下</p>
<ul>
<li>1）如果一个操作 <code>happens-before</code> 另一个操作，那么第一个操作的执行结果将对第二个操作可见。（可见性）</li>
<li>2）两个操作之间存在 <code>happens-before</code> 关系，并不意味着 Java 平台的具体实现必须要按照 <code>happens-before</code> 关系指定的顺序来执行。如果重排序之后的执行结果，与按 <code>happens-before</code> 关系来执行的结果一致，那么这种重排序并不非法（也就是说，JMM 允许这种重排序）（允许指令重排序，只要单线程下结果与Happends-before关系执行的结果一致）</li>
</ul>
<p>（1）是JMM对程序员的承诺。<br>（2）是JMM对编译器和处理器重排序的约束原则。</p>
<p>两个操作存在happends-before关系，表达含义的是：</p>
<p>Two actions can be ordered by a happens-before relationship. If one action happens before another, then the first is visible to and ordered before the second.</p>
<h2 id="主要的happens-before规则："><a href="#主要的happens-before规则：" class="headerlink" title="主要的happens-before规则："></a>主要的happens-before规则：</h2><p>笔者翻译水平有限，为保证信息准确性，采用英语原文。足够简介易懂。</p>
<p>出处：<a target="_blank" rel="noopener" href="https://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf">https://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf</a></p>
<ul>
<li><p>Each action in a thread happens before every subsequent action in that thread.</p>
</li>
<li><p>An unlock on a monitor happens before every subsequent lock on that monitor.</p>
</li>
<li><p>A write to a volatile field happens before every subsequent read of that volatile.</p>
</li>
<li><p>A call to start() on a thread happens before any actions in the started thread.</p>
</li>
<li><p>All actions in a thread happen before any other thread successfully returns from a join() on that thread.</p>
</li>
<li><p>If an action a happens before an action b, and b happens before an action c, then a happens before c.</p>
</li>
</ul>
<h1 id="同步原语语义"><a href="#同步原语语义" class="headerlink" title="同步原语语义"></a>同步原语语义</h1><p>介绍volatile，final和锁在内存可见性方面的作用</p>
<h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><h3 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h3><ul>
<li>可见性</li>
</ul>
<p>对一个volatile变量的读，总是能看到（任意线程）对这个volatile变量的最后的写入</p>
<ul>
<li>原子性</li>
</ul>
<p>对于任意单个volatile变量的读写具有原子性，但是volatile x++这种复合语句不具有原子性。</p>
<h3 id="内存层面实现"><a href="#内存层面实现" class="headerlink" title="内存层面实现"></a>内存层面实现</h3><ul>
<li><p>写<br>当写一个volatile变量时，JMM会把该线程对应的本地内存种的共享变量值刷新到主内存</p>
</li>
<li><p>读<br>当读一个volatile变量时，JMM会把该线程对应的本地内存置为无效。线程将从主内存种读取共享变量。</p>
</li>
</ul>
<p>实际上，写一个volatile变量，相当于发送给其他（将要读这个变量的）线程，此共享变量值已经修改这一消息。</p>
<p>读一个volatile变量，相当于接收到了之前某线程发出的，修改该共享变量的消息。</p>
<p>实际上，相当于写线程通过内存向其他读线程发送消息。</p>
<h3 id="JMM-层面的实现（内存屏障）"><a href="#JMM-层面的实现（内存屏障）" class="headerlink" title="JMM 层面的实现（内存屏障）"></a>JMM 层面的实现（内存屏障）</h3><p>基于保守策略的JMM内存屏障插入策略</p>
<ul>
<li>写操作：</li>
</ul>
<p>在每一个volatile写操作 <strong>前面</strong> 插入一个 storestore屏障</p>
<p>在每一个volatile写操作 <strong>后面</strong> 插入一个 storeload屏障</p>
<ul>
<li>读操作：</li>
</ul>
<p>在每一个volatile读操作 <strong>后面</strong> 插入一个 loadload屏障</p>
<p>在每一个volatile读操作 <strong>后面</strong> 插入一个 loadstore屏障</p>
<h3 id="openjdk源码实现"><a href="#openjdk源码实现" class="headerlink" title="openjdk源码实现"></a>openjdk源码实现</h3><p>使用javap -v 生成并查看字节码，发现涉及volatile变量的读写，和普通变量无明显差异，差异在于附带了<code>flags: ACC_VOLATILE</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sun.hotspot.tools.compiler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Constants</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span>  <span class="variable">JVM_ACC_VOLATILE</span>      <span class="operator">=</span> <span class="number">0x0040</span>;  <span class="comment">/* can not cache in registers */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面以<code>GraphBuilder::method_return</code> 方法为例，说明标志位的作用</p>
<p><code>GraphBuilder::method_return</code> 方法是 JVM即时编译器（JIT Compiler）中的一个关键组件，主要负责在方法返回时构建中间表示（Intermediate Representation, IR）的逻辑</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GraphBuilder::method_return</span><span class="params">(Value x, <span class="type">bool</span> ignore_return)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (RegisterFinalizersAtInit &amp;&amp;</span><br><span class="line">      <span class="built_in">method</span>()-&gt;<span class="built_in">intrinsic_id</span>() == vmIntrinsics::_Object_init) &#123;</span><br><span class="line">    <span class="built_in">call_register_finalizer</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The conditions for a memory barrier are described in Parse::do_exits().</span></span><br><span class="line">  <span class="comment">// 判断是否需要插入内存屏障</span></span><br><span class="line">  <span class="type">bool</span> need_mem_bar = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">method</span>()-&gt;<span class="built_in">name</span>() == ciSymbol::<span class="built_in">object_initializer_name</span>() &amp;&amp;</span><br><span class="line">       (<span class="built_in">scope</span>()-&gt;<span class="built_in">wrote_final</span>() ||</span><br><span class="line">         (AlwaysSafeConstructors &amp;&amp; <span class="built_in">scope</span>()-&gt;<span class="built_in">wrote_fields</span>()) ||</span><br><span class="line">         (support_IRIW_for_not_multiple_copy_atomic_cpu &amp;&amp; <span class="built_in">scope</span>()-&gt;<span class="built_in">wrote_volatile</span>()))) &#123;</span><br><span class="line">    need_mem_bar = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据返回类型处理返回值</span></span><br><span class="line">  BasicType bt = <span class="built_in">method</span>()-&gt;<span class="built_in">return_type</span>()-&gt;<span class="built_in">basic_type</span>();</span><br><span class="line">  <span class="keyword">switch</span> (bt) &#123;</span><br><span class="line">    <span class="keyword">case</span> T_BYTE:</span><br><span class="line">    &#123;</span><br><span class="line">      Value shift = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">Constant</span>(<span class="keyword">new</span> <span class="built_in">IntConstant</span>(<span class="number">24</span>)));</span><br><span class="line">      x = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">ShiftOp</span>(Bytecodes::_ishl, x, shift));</span><br><span class="line">      x = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">ShiftOp</span>(Bytecodes::_ishr, x, shift));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> T_SHORT:</span><br><span class="line">    &#123;</span><br><span class="line">      Value shift = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">Constant</span>(<span class="keyword">new</span> <span class="built_in">IntConstant</span>(<span class="number">16</span>)));</span><br><span class="line">      x = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">ShiftOp</span>(Bytecodes::_ishl, x, shift));</span><br><span class="line">      x = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">ShiftOp</span>(Bytecodes::_ishr, x, shift));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> T_CHAR:</span><br><span class="line">    &#123;</span><br><span class="line">      Value mask = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">Constant</span>(<span class="keyword">new</span> <span class="built_in">IntConstant</span>(<span class="number">0xFFFF</span>)));</span><br><span class="line">      x = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">LogicOp</span>(Bytecodes::_iand, x, mask));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> T_BOOLEAN:</span><br><span class="line">    &#123;</span><br><span class="line">      Value mask = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">Constant</span>(<span class="keyword">new</span> <span class="built_in">IntConstant</span>(<span class="number">1</span>)));</span><br><span class="line">      x = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">LogicOp</span>(Bytecodes::_iand, x, mask));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check to see whether we are inlining. If so, Return</span></span><br><span class="line">  <span class="comment">// instructions become Gotos to the continuation point.</span></span><br><span class="line">  <span class="comment">// 处理内联方法的返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">continuation</span>() != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> invoke_bci = <span class="built_in">state</span>()-&gt;<span class="built_in">caller_state</span>()-&gt;<span class="built_in">bci</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x != <span class="literal">NULL</span>  &amp;&amp; !ignore_return) &#123;</span><br><span class="line">      ciMethod* caller = <span class="built_in">state</span>()-&gt;<span class="built_in">scope</span>()-&gt;<span class="built_in">caller</span>()-&gt;<span class="built_in">method</span>();</span><br><span class="line">      Bytecodes::Code invoke_raw_bc = caller-&gt;<span class="built_in">raw_code_at_bci</span>(invoke_bci);</span><br><span class="line">      <span class="keyword">if</span> (invoke_raw_bc == Bytecodes::_invokehandle || invoke_raw_bc == Bytecodes::_invokedynamic) &#123;</span><br><span class="line">        ciType* declared_ret_type = caller-&gt;<span class="built_in">get_declared_signature_at_bci</span>(invoke_bci)-&gt;<span class="built_in">return_type</span>();</span><br><span class="line">        <span class="keyword">if</span> (declared_ret_type-&gt;<span class="built_in">is_klass</span>() &amp;&amp; x-&gt;<span class="built_in">exact_type</span>() == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">            x-&gt;<span class="built_in">declared_type</span>() != declared_ret_type &amp;&amp; declared_ret_type != <span class="built_in">compilation</span>()-&gt;<span class="built_in">env</span>()-&gt;<span class="built_in">Object_klass</span>()) &#123;</span><br><span class="line">          x = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">TypeCast</span>(declared_ret_type-&gt;<span class="built_in">as_klass</span>(), x, <span class="built_in">copy_state_before</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(!<span class="built_in">method</span>()-&gt;<span class="built_in">is_synchronized</span>() || InlineSynchronizedMethods, <span class="string">&quot;can not inline synchronized methods yet&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">compilation</span>()-&gt;<span class="built_in">env</span>()-&gt;<span class="built_in">dtrace_method_probes</span>()) &#123;</span><br><span class="line">      <span class="comment">// Report exit from inline methods</span></span><br><span class="line">      Values* args = <span class="keyword">new</span> <span class="built_in">Values</span>(<span class="number">1</span>);</span><br><span class="line">      args-&gt;<span class="built_in">push</span>(<span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">Constant</span>(<span class="keyword">new</span> <span class="built_in">MethodConstant</span>(<span class="built_in">method</span>()))));</span><br><span class="line">      <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">RuntimeCall</span>(voidType, <span class="string">&quot;dtrace_method_exit&quot;</span>, <span class="built_in">CAST_FROM_FN_PTR</span>(address, SharedRuntime::dtrace_method_exit), args));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the inlined method is synchronized, the monitor must be</span></span><br><span class="line">    <span class="comment">// released before we jump to the continuation block.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">method</span>()-&gt;<span class="built_in">is_synchronized</span>()) &#123;</span><br><span class="line">      <span class="built_in">assert</span>(<span class="built_in">state</span>()-&gt;<span class="built_in">locks_size</span>() == <span class="number">1</span>, <span class="string">&quot;receiver must be locked here&quot;</span>);</span><br><span class="line">      <span class="built_in">monitorexit</span>(<span class="built_in">state</span>()-&gt;<span class="built_in">lock_at</span>(<span class="number">0</span>), SynchronizationEntryBCI);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要内存屏障，插入 StoreStore 内存屏障</span></span><br><span class="line">    <span class="keyword">if</span> (need_mem_bar) &#123;</span><br><span class="line">      <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">MemBar</span>(lir_membar_storestore));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// State at end of inlined method is the state of the caller</span></span><br><span class="line">    <span class="comment">// without the method parameters on stack, including the</span></span><br><span class="line">    <span class="comment">// return value, if any, of the inlined method on operand stack.</span></span><br><span class="line">    <span class="built_in">set_state</span>(<span class="built_in">state</span>()-&gt;<span class="built_in">caller_state</span>()-&gt;<span class="built_in">copy_for_parsing</span>());</span><br><span class="line">    <span class="keyword">if</span> (x != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!ignore_return) &#123;</span><br><span class="line">        <span class="built_in">state</span>()-&gt;<span class="built_in">push</span>(x-&gt;<span class="built_in">type</span>(), x);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">profile_return</span>() &amp;&amp; x-&gt;<span class="built_in">type</span>()-&gt;<span class="built_in">is_object_kind</span>()) &#123;</span><br><span class="line">        ciMethod* caller = <span class="built_in">state</span>()-&gt;<span class="built_in">scope</span>()-&gt;<span class="built_in">method</span>();</span><br><span class="line">        <span class="built_in">profile_return_type</span>(x, <span class="built_in">method</span>(), caller, invoke_bci);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Goto* goto_callee = <span class="keyword">new</span> <span class="built_in">Goto</span>(<span class="built_in">continuation</span>(), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// See whether this is the first return; if so, store off some</span></span><br><span class="line">    <span class="comment">// of the state for later examination</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">num_returns</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">set_inline_cleanup_info</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The current bci() is in the wrong scope, so use the bci() of</span></span><br><span class="line">    <span class="comment">// the continuation point.</span></span><br><span class="line">    <span class="built_in">append_with_bci</span>(goto_callee, <span class="built_in">scope_data</span>()-&gt;<span class="built_in">continuation</span>()-&gt;<span class="built_in">bci</span>());</span><br><span class="line">    <span class="built_in">incr_num_returns</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">state</span>()-&gt;<span class="built_in">truncate_stack</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">method</span>()-&gt;<span class="built_in">is_synchronized</span>()) &#123;</span><br><span class="line">    <span class="comment">// perform the unlocking before exiting the method</span></span><br><span class="line">    Value receiver;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">method</span>()-&gt;<span class="built_in">is_static</span>()) &#123;</span><br><span class="line">      receiver = _initial_state-&gt;<span class="built_in">local_at</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      receiver = <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">Constant</span>(<span class="keyword">new</span> <span class="built_in">ClassConstant</span>(<span class="built_in">method</span>()-&gt;<span class="built_in">holder</span>())));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">append_split</span>(<span class="keyword">new</span> <span class="built_in">MonitorExit</span>(receiver, <span class="built_in">state</span>()-&gt;<span class="built_in">unlock</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (need_mem_bar) &#123;</span><br><span class="line">      <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">MemBar</span>(lir_membar_storestore));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span>(!ignore_return, <span class="string">&quot;Ignoring return value works only for inlining&quot;</span>);</span><br><span class="line">  <span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">Return</span>(x));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可见，根据volatile，final等标识，将内存屏障插入到中间表示（IR）中，以确保内存操作的有序性和可见性</p>
<p>JIT 编译器在将 IR 图转换为机器代码时，会根据 MemBar 节点插入适当的内存屏障指令。这些指令依赖于底层硬件架构（如 x86、ARM 等），以实现内存操作的有序性。</p>
<p>最后x86使用的是类似mfense, sfense等指令</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// assembler_x86.cpp</span></span><br><span class="line"><span class="comment">// Emit mfence instruction</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Assembler::mfence</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">NOT_LP64</span>(<span class="built_in">assert</span>(VM_Version::<span class="built_in">supports_sse2</span>(), <span class="string">&quot;unsupported&quot;</span>);)</span><br><span class="line">  <span class="built_in">emit_int24</span>(<span class="number">0x0F</span>, (<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0xAE</span>, (<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0xF0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Emit sfence instruction</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Assembler::sfence</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">NOT_LP64</span>(<span class="built_in">assert</span>(VM_Version::<span class="built_in">supports_sse2</span>(), <span class="string">&quot;unsupported&quot;</span>);)</span><br><span class="line">  <span class="built_in">emit_int24</span>(<span class="number">0x0F</span>, (<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0xAE</span>, (<span class="type">unsigned</span> <span class="type">char</span>)<span class="number">0xF8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于x86等处理器，本身可能不禁止某些重排序，而JMM为了保证在某些情况下，禁掉重排序，方法是在某些时候，额外加上了fence相关指令，再交给处理器进行处理。</p>
<h2 id="final"><a href="#final" class="headerlink" title="final"></a>final</h2><ul>
<li>写</li>
</ul>
<p>JMM 禁止编译器把final域的写操作，重排序到构造方法外</p>
<p>编译器会在final域的写之后，构造方法return 之前，加入一个StoreStore屏障。</p>
<p>这样可以确保：在对象引用为任意线程可见之前， <strong>对象的final域已经被正确初始化过</strong> 。 而 <strong>普通的域的初始化，可能被重排序到构造方法之外。</strong></p>
<ul>
<li>读</li>
</ul>
<p>一个线程中，初次读对象引用与初次读对象包含的final域，JMM禁止处理器重排序这两个操作。（读final域前面插入一个LoadLoad屏障）</p>
<p>这确保了读一个对象的final域之前，<strong>一定先读包含这个final域的对象的引用</strong> 。结合前面的写规则，可以发现，<strong>如果对象引用不为null，则该对象中的final域一定被初始化过</strong> 。</p>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>锁可以让临界区互斥执行，此外，也有很重要的内存语义</p>
<p>线程释放锁时，JMM会把该线程对应的本地内存中的共享变量刷新到主存中</p>
<p>线程获取锁时，JMM会把该线程对应的本地内存置为无效。</p>
<p>也即，锁释放与volatile写有相同的内存语义，锁获取与volatile读有相同的内存语义。</p>
<p>锁与volatile表现不同的原因，在于有互斥性，这可以确保 <strong>整个临界区的原子性</strong> 。而volatile不保证互斥性，性能会更好些。注意在适当的时机，选择使用锁和volatile。</p>
<p>更详细的说明，可以阅读下面的文章（Java Concurrency in Practice）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/AngelSanchezT/books-1/blob/master/concurrency/Java%20Concurrency%20in%20Practice.pdf">https://github.com/AngelSanchezT/books-1/blob/master/concurrency/Java%20Concurrency%20in%20Practice.pdf</a></p>
<h1 id="自测回顾"><a href="#自测回顾" class="headerlink" title="自测回顾"></a>自测回顾</h1><p>阅读本文章和相关文章后，尝试回答下列问题</p>
<blockquote>
<p>什么是内存模型，为什么<code>Java</code>需要引入内存模型</p>
</blockquote>
<blockquote>
<p>概括 happens-before关系</p>
</blockquote>
<blockquote>
<p>编写测试用例，证明volatile变量的++操作不是原子性的，并分析原因</p>
</blockquote>
<blockquote>
<p>分析以下单例代码实现，说明是否存在问题，如有，如何修改</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(A.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... other attributes and methods</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>试阅读下列测试用例，分析理解结果（20个，网站有提供解析）</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cs.umd.edu/~pugh/java/memoryModel/CausalityTestCases.html">https://www.cs.umd.edu/~pugh/java/memoryModel/CausalityTestCases.html</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>《并发算法与理论》(Concurrency: Algorithms and Theories) 南京大学计算机课程 梁红谨</p>
<p>《多处理器编程的艺术》(The art of multiprocessor programming) 机械工业出版社</p>
<p>《Java 并发编程的艺术》(The Art of Java Concurrency Programming) 机械工业出版社</p>
<p><a target="_blank" rel="noopener" href="https://preshing.com/20120930/weak-vs-strong-memory-models/">https://preshing.com/20120930/weak-vs-strong-memory-models/</a></p>
<p>The official site for JSR 133 - The Java(tm) Memory Model and Thread Specification Revision:<br><a target="_blank" rel="noopener" href="https://www.jcp.org/en/jsr/detail?id=133">https://www.jcp.org/en/jsr/detail?id=133</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cs.umd.edu/~pugh/java/memoryModel/">https://www.cs.umd.edu/~pugh/java/memoryModel/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf">https://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://gee.cs.oswego.edu/dl/cpj/jmm.html">https://gee.cs.oswego.edu/dl/cpj/jmm.html</a></p>
<p><a target="_blank" rel="noopener" href="https://jenkov.com/tutorials/java-concurrency/java-memory-model.html">https://jenkov.com/tutorials/java-concurrency/java-memory-model.html</a></p>
<p><a target="_blank" rel="noopener" href="https://dip-mazumder.medium.com/java-memory-model-a-comprehensive-guide-ba9643b839e">https://dip-mazumder.medium.com/java-memory-model-a-comprehensive-guide-ba9643b839e</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/AngelSanchezT/books-1/blob/master/concurrency/Java%20Concurrency%20in%20Practice.pdf">https://github.com/AngelSanchezT/books-1/blob/master/concurrency/Java%20Concurrency%20in%20Practice.pdf</a></p>
<p>testcases:</p>
<p><a target="_blank" rel="noopener" href="https://www.cs.umd.edu/~pugh/java/memoryModel/CausalityTestCases.html">https://www.cs.umd.edu/~pugh/java/memoryModel/CausalityTestCases.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://jinglong-liu.github.io">liujinglong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://jinglong-liu.github.io/2024/10/06/juc-jmm/">https://jinglong-liu.github.io/2024/10/06/juc-jmm/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jinglong-liu.github.io" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/juc/">juc</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/09/18/asehw-1/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">liujinglong</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">问题引入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#memory-model"><span class="toc-number">2.</span> <span class="toc-text">memory model</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E5%AD%98%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AD%98"><span class="toc-number">2.1.</span> <span class="toc-text">主存与工作内存</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="toc-number">3.</span> <span class="toc-text">重排序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C"><span class="toc-number">3.1.</span> <span class="toc-text">内存屏障</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99%EF%BC%9Aas-if-serial"><span class="toc-number">3.2.</span> <span class="toc-text">重排序规则：as-if-serial</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#happens-before"><span class="toc-number">4.</span> <span class="toc-text">happens-before</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E7%9A%84happens-before%E8%A7%84%E5%88%99%EF%BC%9A"><span class="toc-number">4.1.</span> <span class="toc-text">主要的happens-before规则：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%8E%9F%E8%AF%AD%E8%AF%AD%E4%B9%89"><span class="toc-number">5.</span> <span class="toc-text">同步原语语义</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#volatile"><span class="toc-number">5.1.</span> <span class="toc-text">volatile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%B4%A8"><span class="toc-number">5.1.1.</span> <span class="toc-text">性质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%82%E9%9D%A2%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.2.</span> <span class="toc-text">内存层面实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JMM-%E5%B1%82%E9%9D%A2%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%88%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%EF%BC%89"><span class="toc-number">5.1.3.</span> <span class="toc-text">JMM 层面的实现（内存屏障）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openjdk%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.4.</span> <span class="toc-text">openjdk源码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#final"><span class="toc-number">5.2.</span> <span class="toc-text">final</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81"><span class="toc-number">5.3.</span> <span class="toc-text">锁</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E6%B5%8B%E5%9B%9E%E9%A1%BE"><span class="toc-number">6.</span> <span class="toc-text">自测回顾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">7.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/06/juc-jmm/" title="Java 内存模型 (JMM)">Java 内存模型 (JMM)</a><time datetime="2024-10-06T00:50:17.000Z" title="发表于 2024-10-06 08:50:17">2024-10-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/18/asehw-1/" title="无题">无题</a><time datetime="2024-09-18T10:49:38.048Z" title="发表于 2024-09-18 18:49:38">2024-09-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/10/build-open-jdk/" title="build-open-jdk">build-open-jdk</a><time datetime="2024-09-10T04:38:55.000Z" title="发表于 2024-09-10 12:38:55">2024-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/08/redis-listpack/" title="listpack, ziplist, quicklist">listpack, ziplist, quicklist</a><time datetime="2024-09-08T00:05:26.000Z" title="发表于 2024-09-08 08:05:26">2024-09-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/08/skiplist/" title="zset 与 skiplist">zset 与 skiplist</a><time datetime="2024-09-08T00:05:26.000Z" title="发表于 2024-09-08 08:05:26">2024-09-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By liujinglong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.14.0-b2"></script><script src="/js/main.js?v=4.14.0-b2"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.innerHTML = `<pre class="mermaid-src" hidden>${ele.textContent}</pre>`
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '4JE6J6Fimc9mBF9PTJvsX6P2-gzGzoHsz',
      appKey: '0F61JyHXoFJLYMGMy6p9aZhN',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>