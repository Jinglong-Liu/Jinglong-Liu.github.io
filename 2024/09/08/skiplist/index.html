<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>zset 与 skiplist | Hexo</title><meta name="author" content="liujinglong"><meta name="copyright" content="liujinglong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="引言跳表(SkipList) 是一种数据结构。因为redis的zset(有序集合) 使用跳表作为底层数据结构，因此也是面试常考项。为此，本文结合redis源码以及leetcode相关题目，来讲解一下跳表的数据结构，并和B+树，红黑树做一个简要的对比。 redis 调试环境搭建下面用vscode + ssh 搭建一个redis源码调试环境，方便学习。不感兴趣的读者可以跳过本章节。 下载源码在 htt">
<meta property="og:type" content="article">
<meta property="og:title" content="zset 与 skiplist">
<meta property="og:url" content="https://jinglong-liu.github.io/2024/09/08/skiplist/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="引言跳表(SkipList) 是一种数据结构。因为redis的zset(有序集合) 使用跳表作为底层数据结构，因此也是面试常考项。为此，本文结合redis源码以及leetcode相关题目，来讲解一下跳表的数据结构，并和B+树，红黑树做一个简要的对比。 redis 调试环境搭建下面用vscode + ssh 搭建一个redis源码调试环境，方便学习。不感兴趣的读者可以跳过本章节。 下载源码在 htt">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-09-08T00:05:26.000Z">
<meta property="article:modified_time" content="2024-09-08T09:11:55.013Z">
<meta property="article:author" content="liujinglong">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://jinglong-liu.github.io/2024/09/08/skiplist/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.14.0-b2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'zset 与 skiplist',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-08 17:11:55'
}</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">zset 与 skiplist</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-08T00:05:26.000Z" title="发表于 2024-09-08 08:05:26">2024-09-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-08T09:11:55.013Z" title="更新于 2024-09-08 17:11:55">2024-09-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2024/09/08/skiplist/" data-flag-title="zset 与 skiplist"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>跳表(<code>SkipList</code>) 是一种数据结构。因为<code>redis</code>的<code>zset</code>(有序集合) 使用跳表作为底层数据结构，因此也是面试常考项。为此，本文结合<code>redis</code>源码以及<code>leetcode</code>相关题目，来讲解一下跳表的数据结构，并和B+树，红黑树做一个简要的对比。</p>
<h1 id="redis-调试环境搭建"><a href="#redis-调试环境搭建" class="headerlink" title="redis 调试环境搭建"></a>redis 调试环境搭建</h1><p>下面用<code>vscode + ssh</code> 搭建一个redis源码调试环境，方便学习。不感兴趣的读者可以跳过本章节。</p>
<h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>在 <a target="_blank" rel="noopener" href="https://github.com/redis/redis/releases">https://github.com/redis/redis/releases</a> 选择对应的版本，下载对应的tar.gz</p>
<p>放到虚拟机对应目录</p>
<p>下面以<code>redis-7.4.0</code>为例</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>安装<code>gcc</code>, <code>gdb</code></p>
<p>在<code>redis-7.4.0</code> 目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<h2 id="vscode-调试环境配置"><a href="#vscode-调试环境配置" class="headerlink" title="vscode 调试环境配置"></a>vscode 调试环境配置</h2><p>这边采用 <code>vscode + ssh</code>的方式，搭建调试环境。读者也可以使用自己喜欢的方式今天源码的阅读与调试。</p>
<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><p>安装插件 <code>Remote - SSH</code>, 连接虚拟机</p>
<h3 id="配置launch-和-tasks"><a href="#配置launch-和-tasks" class="headerlink" title="配置launch 和 tasks"></a>配置launch 和 tasks</h3><p>在<code>setting.json</code>(一般位于<code>C:\Users\&#123;user&#125;\AppData\Roaming\Code\User</code>) 的<code>launch.configurations</code> 标签(数组类型)下，添加配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;launch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;redis-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/src/redis-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;redis.conf&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;为 gdb 启用整齐打印&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;将反汇编风格设置为 Intel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-gdb-set disassembly-flavor intel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build-redis-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;miDebuggerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/gdb&quot;</span></span><br><span class="line">       <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;compounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>并在<code>tasks.json</code>(相同目录，没有就新建)，添加tasks配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppbuild&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build-redis-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;make&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;$gcc&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="redis-server-启动"><a href="#redis-server-启动" class="headerlink" title="redis-server 启动"></a>redis-server 启动</h3><p>然后点击<code>VSCode</code> 中的 <code>Run and Debug</code>，选择任务 <code>redis-server</code>，即可调试启动redis 服务</p>
<h3 id="redis-client-启动"><a href="#redis-client-启动" class="headerlink" title="redis-client 启动"></a>redis-client 启动</h3><p>可以直接启动自带的<code>redis-client</code>工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./src/redis-client</span><br></pre></td></tr></table></figure>

<p>然后就可以发命令，在源码中需要的地方加断点调试了</p>
<p>以下若未加以说明，<code>redis</code>源码全部为<code>7.4.0</code>版本</p>
<h1 id="redis-zset"><a href="#redis-zset" class="headerlink" title="redis zset"></a>redis zset</h1><p>众所周知，有序集合<code>zset</code>使用到跳表(<code>skiplist</code>)这一数据结构。但如果面试这么回答，是不完整的。下面同通过阅读和调试源码的方式，来确定这一问题的答案。</p>
<p>调试过程我们发现，在<code>redis-7.4.0</code>版本中，<code>zset</code>使用<code>listpack</code>，似乎不是<code>skiplist</code>。</p>
<h2 id="zset-数据结构探索"><a href="#zset-数据结构探索" class="headerlink" title="zset 数据结构探索"></a>zset 数据结构探索</h2><p><img src="https://jinglong-liu.github.io/images/redis/11.png" alt="11"></p>
<p><img src="https://jinglong-liu.github.io/images/redis/zsetadd-1.png" alt="zsetadd-1"></p>
<p>zadd中调试发现，一开始使用的是listpack(对应的type为11)</p>
<p>根据注释</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* The command as a side effect of adding a new element may convert the sorted</span><br><span class="line">* set internal encoding from listpack to hashtable+skiplist.</span><br></pre></td></tr></table></figure>

<p>以及gpt，得知在key数量过多时，数据结构会转换成skiplist</p>
<p>下面查看转化阈值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CONFIG GET zset-max-listpack-entries</span><br><span class="line">1) &quot;zset-max-listpack-entries&quot;</span><br><span class="line">2) &quot;128&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET zset-max-listpack-value</span><br><span class="line">1) &quot;zset-max-listpack-value&quot;</span><br><span class="line">2) &quot;64&quot;</span><br></pre></td></tr></table></figure>

<p>前者表示元素数量阈值，后者表示元素大小阈值。超过阈值，zset的listpack会变成skiplist</p>
<p>下面查看数据结构转换的代码</p>
<p>我们发现，对于<code>zobj-&gt;encoding</code>的判断，没有使用else，实际上因为，当前类型为<code>listpack</code>时会做一个判断，如果add之后，超过了阈值，会转换成为<code>skiplist</code>，代码如下。源码的注释非常易懂，因此不做翻译或者修改。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">zsetAdd</span><span class="params">(robj *zobj, <span class="type">double</span> score, sds ele, <span class="type">int</span> in_flags, <span class="type">int</span> *out_flags, <span class="type">double</span> *newscore)</span> &#123;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Update the sorted set according to its encoding. */</span></span><br><span class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_LISTPACK) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> *eptr;</span><br><span class="line">        <span class="keyword">if</span> ((eptr = zzlFind(zobj-&gt;ptr,ele,&amp;curscore)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!xx) &#123;</span><br><span class="line">            <span class="comment">/* check if the element is too large or the list</span></span><br><span class="line"><span class="comment">             * becomes too long *before* executing zzlInsert. */</span></span><br><span class="line">            <span class="keyword">if</span> (zzlLength(zobj-&gt;ptr)+<span class="number">1</span> &gt; server.zset_max_listpack_entries ||</span><br><span class="line">                sdslen(ele) &gt; server.zset_max_listpack_value ||</span><br><span class="line">                !lpSafeToAdd(zobj-&gt;ptr, sdslen(ele)))</span><br><span class="line">            &#123;</span><br><span class="line">                zsetConvertAndExpand(zobj, OBJ_ENCODING_SKIPLIST, zsetLength(zobj) + <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                zobj-&gt;ptr = zzlInsert(zobj-&gt;ptr,ele,score);</span><br><span class="line">                <span class="keyword">if</span> (newscore) *newscore = score;</span><br><span class="line">                *out_flags |= ZADD_OUT_ADDED;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *out_flags |= ZADD_OUT_NOP;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Note that the above block handling listpack would have either returned or</span></span><br><span class="line"><span class="comment">     * converted the key to skiplist. */</span></span><br><span class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_SKIPLIST) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverPanic(<span class="string">&quot;Unknown sorted set encoding&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* Never reached. */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>zsetConvertAndExpand</code> 负责对应条件下，listpack和skiplist相互转换。</p>
<p>zsetAdd 流程图</p>
<img src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI0NDdweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjM4MHB4O2hlaWdodDo0NDdweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAzODAgNDQ3IiB3aWR0aD0iMzgwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48ZWxsaXBzZSBjeD0iMTgyLjA5MDgiIGN5PSIyMCIgZmlsbD0iIzIyMjIyMiIgcng9IjEwIiByeT0iMTAiIHN0eWxlPSJzdHJva2U6IzIyMjIyMjtzdHJva2Utd2lkdGg6MS4wOyIvPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMDcuMzkyNiIgeD0iMTI4LjM5NDUiIHk9IjUwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODcuMzkyNiIgeD0iMTM4LjM5NDUiIHk9IjcxLjEzODciPnpzZXRBZGQobm9kZSk8L3RleHQ+PHBvbHlnb24gZmlsbD0iI0YxRjFGMSIgcG9pbnRzPSIxNDkuNzk5OCwxNTIuMzcxMSwyMTQuMzgxOCwxNTIuMzcxMSwyMjYuMzgxOCwxNjQuMzcxMSwyMTQuMzgxOCwxNzYuMzcxMSwxNDkuNzk5OCwxNzYuMzcxMSwxMzcuNzk5OCwxNjQuMzcxMSwxNDkuNzk5OCwxNTIuMzcxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjQuNTgyIiB4PSIxNDkuNzk5OCIgeT0iMTY4LjE3OTIiPnJlYWNoIGxpbWl0PzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOS4wMDgzIiB4PSIxMTguNzkxNSIgeT0iMTYxLjc3NjkiPnllczwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMy43MDE3IiB4PSIyMjYuMzgxOCIgeT0iMTYxLjc3NjkiPm5vPC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNjcuMzk4NCIgeD0iMTEiIHk9IjE4Ni4zNzExIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ3LjM5ODQiIHg9IjIxIiB5PSIyMDcuNTA5OCI+Y29udmVydCB0eXBlIHRvIFNLSVBMSVNUPC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDIuMTY4IiB4PSIxOTguMzk4NCIgeT0iMTg2LjM3MTEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjIuMTY4IiB4PSIyMDguMzk4NCIgeT0iMjA3LjUwOTgiPmFkZCBub2RlIHRvIGxpc3RwYWNrPC90ZXh0PjxlbGxpcHNlIGN4PSIyNjkuNDgyNCIgY3k9IjI1MS4zMzk4IiBmaWxsPSJub25lIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxLjA7Ii8+PGVsbGlwc2UgY3g9IjI2OS40ODI0IiBjeT0iMjUxLjMzOTgiIGZpbGw9IiMyMjIyMjIiIHJ4PSI2IiByeT0iNiIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iI0YxRjFGMSIgcG9pbnRzPSIxMTMuMzkxOCwxMDMuOTY4OCwyNTAuNzg5OCwxMDMuOTY4OCwyNjIuNzg5OCwxMTUuOTY4OCwyNTAuNzg5OCwxMjcuOTY4OCwxMTMuMzkxOCwxMjcuOTY4OCwxMDEuMzkxOCwxMTUuOTY4OCwxMTMuMzkxOCwxMDMuOTY4OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTkuMDA4MyIgeD0iMTg2LjA5MDgiIHk9IjEzOC4xNzkyIj55ZXM8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM3LjM5NzkiIHg9IjExMy4zOTE4IiB5PSIxMTkuNzc2OSI+ZW5jb2RpbmcgPT0gTElTVFBBQ0sgPzwvdGV4dD48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9IjE4Mi4wOTA4LDI4Mi4zMzk4LDE5NC4wOTA4LDI5NC4zMzk4LDE4Mi4wOTA4LDMwNi4zMzk4LDE3MC4wOTA4LDI5NC4zMzk4LDE4Mi4wOTA4LDI4Mi4zMzk4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cG9seWdvbiBmaWxsPSIjRjFGMUYxIiBwb2ludHM9IjEyOC44NDk5LDMyNi4zMzk4LDIzNS4zMzE4LDMyNi4zMzk4LDI0Ny4zMzE4LDMzOC4zMzk4LDIzNS4zMzE4LDM1MC4zMzk4LDEyOC44NDk5LDM1MC4zMzk4LDExNi44NDk5LDMzOC4zMzk4LDEyOC44NDk5LDMyNi4zMzk4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDYuNDgxOSIgeD0iMTI4Ljg0OTkiIHk9IjM0Mi4xNDc5Ij50eXBlID09IFNLSVBMSVNUID88L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTkuMDA4MyIgeD0iOTcuODQxNiIgeT0iMzM1Ljc0NTYiPnllczwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMSIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMy43MDE3IiB4PSIyNDcuMzMxOCIgeT0iMzM1Ljc0NTYiPm5vPC90ZXh0PjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzMuOTY4OCIgcng9IjEyLjUiIHJ5PSIxMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzcuODAyNyIgeD0iMzcuOTQ4NSIgeT0iMzYwLjMzOTgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTcuODAyNyIgeD0iNDcuOTQ4NSIgeT0iMzgxLjQ3ODUiPmFkZCBub2RlIHRvIHNraXBsaXN0PC90ZXh0PjxlbGxpcHNlIGN4PSIxMDYuODQ5OSIgY3k9IjQyNS4zMDg2IiBmaWxsPSJub25lIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxLjA7Ii8+PGVsbGlwc2UgY3g9IjEwNi44NDk5IiBjeT0iNDI1LjMwODYiIGZpbGw9IiMyMjIyMjIiIHJ4PSI2IiByeT0iNiIgc3R5bGU9InN0cm9rZTojMjIyMjIyO3N0cm9rZS13aWR0aDoxLjA7Ii8+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMy45Njg4IiByeD0iMTIuNSIgcnk9IjEyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ5LjUyNTQiIHg9IjIzMi41NjkxIiB5PSIzNjAuMzM5OCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI5LjUyNTQiIHg9IjI0Mi41NjkxIiB5PSIzODEuNDc4NSI+ZXJyb3I8L3RleHQ+PGVsbGlwc2UgY3g9IjI1Ny4zMzE4IiBjeT0iNDI1LjMwODYiIGZpbGw9Im5vbmUiIHJ4PSIxMSIgcnk9IjExIiBzdHlsZT0ic3Ryb2tlOiMyMjIyMjI7c3Ryb2tlLXdpZHRoOjEuMDsiLz48ZWxsaXBzZSBjeD0iMjU3LjMzMTgiIGN5PSI0MjUuMzA4NiIgZmlsbD0iIzIyMjIyMiIgcng9IjYiIHJ5PSI2IiBzdHlsZT0ic3Ryb2tlOiMyMjIyMjI7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxODIuMDkwOCIgeDI9IjE4Mi4wOTA4IiB5MT0iMzAiIHkyPSI1MCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc4LjA5MDgsNDAsMTgyLjA5MDgsNTAsMTg2LjA5MDgsNDAsMTgyLjA5MDgsNDQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjI2OS40ODI0IiB4Mj0iMjY5LjQ4MjQiIHkxPSIyMjAuMzM5OCIgeTI9IjI0MC4zMzk4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNjUuNDgyNCwyMzAuMzM5OCwyNjkuNDgyNCwyNDAuMzM5OCwyNzMuNDgyNCwyMzAuMzM5OCwyNjkuNDgyNCwyMzQuMzM5OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMTM3Ljc5OTgiIHgyPSI5NC42OTkyIiB5MT0iMTY0LjM3MTEiIHkyPSIxNjQuMzcxMSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9Ijk0LjY5OTIiIHgyPSI5NC42OTkyIiB5MT0iMTY0LjM3MTEiIHkyPSIxODYuMzcxMSIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iOTAuNjk5MiwxNzYuMzcxMSw5NC42OTkyLDE4Ni4zNzExLDk4LjY5OTIsMTc2LjM3MTEsOTQuNjk5MiwxODAuMzcxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjI2LjM4MTgiIHgyPSIyNjkuNDgyNCIgeTE9IjE2NC4zNzExIiB5Mj0iMTY0LjM3MTEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyNjkuNDgyNCIgeDI9IjI2OS40ODI0IiB5MT0iMTY0LjM3MTEiIHkyPSIxODYuMzcxMSIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjY1LjQ4MjQsMTc2LjM3MTEsMjY5LjQ4MjQsMTg2LjM3MTEsMjczLjQ4MjQsMTc2LjM3MTEsMjY5LjQ4MjQsMTgwLjM3MTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9Ijk0LjY5OTIiIHgyPSI5NC42OTkyIiB5MT0iMjIwLjMzOTgiIHkyPSIyNjcuMzM5OCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9Ijk0LjY5OTIiIHgyPSIxODIuMDkwOCIgeTE9IjI2Ny4zMzk4IiB5Mj0iMjY3LjMzOTgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxODIuMDkwOCIgeDI9IjE4Mi4wOTA4IiB5MT0iMjY3LjMzOTgiIHkyPSIyODIuMzM5OCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc4LjA5MDgsMjcyLjMzOTgsMTgyLjA5MDgsMjgyLjMzOTgsMTg2LjA5MDgsMjcyLjMzOTgsMTgyLjA5MDgsMjc2LjMzOTgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE4Mi4wOTA4IiB4Mj0iMTgyLjA5MDgiIHkxPSIxMjcuOTY4OCIgeTI9IjE1Mi4zNzExIi8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNzguMDkwOCwxNDIuMzcxMSwxODIuMDkwOCwxNTIuMzcxMSwxODYuMDkwOCwxNDIuMzcxMSwxODIuMDkwOCwxNDYuMzcxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjYyLjc4OTgiIHgyPSIzNTQuNTY2NCIgeTE9IjExNS45Njg4IiB5Mj0iMTE1Ljk2ODgiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM1MC41NjY0LDIwNy44NTU1LDM1NC41NjY0LDIxNy44NTU1LDM1OC41NjY0LDIwNy44NTU1LDM1NC41NjY0LDIxMS44NTU1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIzNTQuNTY2NCIgeDI9IjM1NC41NjY0IiB5MT0iMTE1Ljk2ODgiIHkyPSIyOTQuMzM5OCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjM1NC41NjY0IiB4Mj0iMTk0LjA5MDgiIHkxPSIyOTQuMzM5OCIgeTI9IjI5NC4zMzk4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMDQuMDkwOCwyOTAuMzM5OCwxOTQuMDkwOCwyOTQuMzM5OCwyMDQuMDkwOCwyOTguMzM5OCwyMDAuMDkwOCwyOTQuMzM5OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMTgyLjA5MDgiIHgyPSIxODIuMDkwOCIgeTE9IjgzLjk2ODgiIHkyPSIxMDMuOTY4OCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTc4LjA5MDgsOTMuOTY4OCwxODIuMDkwOCwxMDMuOTY4OCwxODYuMDkwOCw5My45Njg4LDE4Mi4wOTA4LDk3Ljk2ODgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjEwNi44NDk5IiB4Mj0iMTA2Ljg0OTkiIHkxPSIzOTQuMzA4NiIgeTI9IjQxNC4zMDg2Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMDIuODQ5OSw0MDQuMzA4NiwxMDYuODQ5OSw0MTQuMzA4NiwxMTAuODQ5OSw0MDQuMzA4NiwxMDYuODQ5OSw0MDguMzA4NiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjU3LjMzMTgiIHgyPSIyNTcuMzMxOCIgeTE9IjM5NC4zMDg2IiB5Mj0iNDE0LjMwODYiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1My4zMzE4LDQwNC4zMDg2LDI1Ny4zMzE4LDQxNC4zMDg2LDI2MS4zMzE4LDQwNC4zMDg2LDI1Ny4zMzE4LDQwOC4zMDg2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIxMTYuODQ5OSIgeDI9IjEwNi44NDk5IiB5MT0iMzM4LjMzOTgiIHkyPSIzMzguMzM5OCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjEwNi44NDk5IiB4Mj0iMTA2Ljg0OTkiIHkxPSIzMzguMzM5OCIgeTI9IjM2MC4zMzk4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMDIuODQ5OSwzNTAuMzM5OCwxMDYuODQ5OSwzNjAuMzM5OCwxMTAuODQ5OSwzNTAuMzM5OCwxMDYuODQ5OSwzNTQuMzM5OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7IiB4MT0iMjQ3LjMzMTgiIHgyPSIyNTcuMzMxOCIgeTE9IjMzOC4zMzk4IiB5Mj0iMzM4LjMzOTgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyNTcuMzMxOCIgeDI9IjI1Ny4zMzE4IiB5MT0iMzM4LjMzOTgiIHkyPSIzNjAuMzM5OCIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjUzLjMzMTgsMzUwLjMzOTgsMjU3LjMzMTgsMzYwLjMzOTgsMjYxLjMzMTgsMzUwLjMzOTgsMjU3LjMzMTgsMzU0LjMzOTgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjE4Mi4wOTA4IiB4Mj0iMTgyLjA5MDgiIHkxPSIzMDYuMzM5OCIgeTI9IjMyNi4zMzk4Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNzguMDkwOCwzMTYuMzM5OCwxODIuMDkwOCwzMjYuMzM5OCwxODYuMDkwOCwzMTYuMzM5OCwxODIuMDkwOCwzMjAuMzM5OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PCEtLVNSQz1bUE92RDJlQ201OEp0RVNLaXpHZkFBVEFMczhMV0JuMklQbXRROTJJRldacnpKVGhJbHlyaVBsWmNZb20zMnI3VDhkNlpUTTZUZmg4TW1lbWVvMmdkWkpyWmp5RW43S3Z6Uy1ZbUJ5NEpNSEdobkw4MFFIWDhnV2NCa0haLWhPNUFFTmtibUUzTDR6WFh3RGUtdVVnamZZS0lqakZkTDZnRFA5MWNZdWRpZlBoaE40THNGa3NqRGdEdVA3UkNxQ3RsMVZ0cC1zQjZzVlo0SlNuQ19Gb2xBMEdOdGJLd2tHQzBdLS0+PC9nPjwvc3ZnPg=='>


<h2 id="skiplist"><a href="#skiplist" class="headerlink" title="skiplist"></a>skiplist</h2><p>下面学习skiplist 数据结构，完成leetcode对应题目</p>
<h3 id="skiplist数据结构"><a href="#skiplist数据结构" class="headerlink" title="skiplist数据结构"></a>skiplist数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ZSETs use a specialized version of Skiplists */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    <span class="comment">// 字符串</span></span><br><span class="line">    sds ele;</span><br><span class="line">    <span class="comment">// 用于比较的分数值</span></span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line">    <span class="comment">// 前一个结点（便于倒序遍历）</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></span><br><span class="line">    <span class="comment">// level[0] 对应跳表的第一层（底层），由此类推</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="comment">// 对应level中，下一个结点的指针</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></span><br><span class="line">        <span class="comment">// 记录在当前层级中从当前节点到目标节点的跨度</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></span><br><span class="line">    <span class="comment">// 跳表长度，即最底层包含所元素的链表的长度</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">    <span class="comment">// 当前的层数</span></span><br><span class="line">    <span class="type">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure>

<p>例如，有跳表结构如下，则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Level 2:  H ---- - ---- - ---- - ---- - ---- - ---- - ---- - ---- 8 ---- - ---- -- ---- -- ---- -- ---- -- ---- -- ---- -- ---- 16</span><br><span class="line">    </span><br><span class="line">Level 1:  H ---- - ---- - ---- - ---- 4 ---- - ---- - ---- - ---- 8 ---- - ---- -- ---- -- ---- 12 ---- -- ---- -- ---- -- ---- 16</span><br><span class="line">               </span><br><span class="line">Level 0:  H ---- 1 ---- 2 ---- 3 ---- 4 ---- 5 ---- 6 ---- 7 ---- 8 ---- 9 ---- 10 ---- 11 ---- 12 ---- 13 ---- 14 ---- 15 ---- 16</span><br></pre></td></tr></table></figure>

<ul>
<li>对于跳表，length &#x3D; 16, level &#x3D; 3</li>
</ul>
<table>
<thead>
<tr>
<th><strong>跳表</strong></th>
<th><strong>Level</strong></th>
<th><strong>length</strong></th>
</tr>
</thead>
<tbody><tr>
<td>skiplist</td>
<td>3</td>
<td>16</td>
</tr>
</tbody></table>
<p>对于节点8而言:</p>
<table>
<thead>
<tr>
<th><strong>节点</strong></th>
<th><strong>Level</strong></th>
<th><strong>Forward</strong></th>
<th><strong>Span</strong></th>
</tr>
</thead>
<tbody><tr>
<td>8</td>
<td>0</td>
<td>9</td>
<td>1</td>
</tr>
<tr>
<td>8</td>
<td>1</td>
<td>12</td>
<td>4</td>
</tr>
<tr>
<td>8</td>
<td>2</td>
<td>16</td>
<td>8</td>
</tr>
</tbody></table>
<h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">zskiplistNode *<span class="title function_">zslInsert</span><span class="params">(zskiplist *zsl, <span class="type">double</span> score, sds ele)</span> &#123;</span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="type">int</span> i, level;</span><br><span class="line"></span><br><span class="line">    serverAssert(!isnan(score));</span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line">    <span class="comment">// zsl -&gt; level就是skiplist的最高层数</span></span><br><span class="line">    <span class="comment">// 从上到下找，找到所有层的待插入结点的前置位置update[]</span></span><br><span class="line">    <span class="comment">// rank[i] 表示从当前节点到层级 i 的目标节点之间的跳跃节点数。</span></span><br><span class="line">    <span class="comment">// 平均 O(log N)，最坏 O(N)</span></span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* store rank that is crossed to reach the insert position */</span></span><br><span class="line">        <span class="comment">// 如果是最上层，rank[i] 初始值为 0，否则继承上层的 rank</span></span><br><span class="line">        <span class="comment">// 它代表每个节点在跳跃表中的相对位置</span></span><br><span class="line">        rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 通过跳跃查找正确的位置</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">                    (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                    sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 累计跨度</span></span><br><span class="line">            rank[i] += x-&gt;level[i].span;</span><br><span class="line">            <span class="comment">// 向前移动到下一个节点</span></span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保存找到的更新的位置</span></span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为这个函数不可能处理两个元素的 member 和 score 都相同的情况，</span></span><br><span class="line">    <span class="comment">// 所以直接创建新节点，不需要额外检查</span></span><br><span class="line">    <span class="comment">// 随机生成一个层数值</span></span><br><span class="line">    level = zslRandomLevel();</span><br><span class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">        <span class="comment">// 随机生成的层数比当前跳表的最高层数要高，为多出的层数创建结点</span></span><br><span class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span>;</span><br><span class="line">            update[i] = zsl-&gt;header;</span><br><span class="line">            <span class="comment">// 设置跨度为当前长度</span></span><br><span class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录最高层数</span></span><br><span class="line">        zsl-&gt;level = level;</span><br><span class="line">    &#125;</span><br><span class="line">    x = zslCreateNode(level,score,ele);</span><br><span class="line">    <span class="comment">// 0~level 层，更新update结点</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">        <span class="comment">// update -&gt; forward</span></span><br><span class="line">        <span class="comment">// update -&gt; x -&gt; forword</span></span><br><span class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">        update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* update span covered by update[i] as x is inserted here */</span></span><br><span class="line">        <span class="comment">// 更新跨度</span></span><br><span class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* increment span for untouched levels */</span></span><br><span class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        <span class="comment">// 对未被更新的层级，对应结点跨度 + 1，所以前面需要找到所有的update[]</span></span><br><span class="line">        update[i]-&gt;level[i].span++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 如果是最后一个节点，更新 tail</span></span><br><span class="line">        zsl-&gt;tail = x;</span><br><span class="line">    <span class="comment">// 增加跳表长度</span></span><br><span class="line">    zsl-&gt;length++;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="zslRandomLevel"><a href="#zslRandomLevel" class="headerlink" title="zslRandomLevel"></a>zslRandomLevel</h3><p>zsetAdd中，zslRandomLevel作用是随机生成一个level，那么如何保证最后生成的跳表，是近似于完全k叉树的？</p>
<p>源码非常简单</p>
<p>作用就是生成一个1 ~ ZSKIPLIST_MAXLEVEL(闭区间)的一个值，作为新插入的结点的层数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns a random level for the new skiplist node we are going to create.</span></span><br><span class="line"><span class="comment"> * The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL</span></span><br><span class="line"><span class="comment"> * (both inclusive), with a powerlaw-alike distribution where higher</span></span><br><span class="line"><span class="comment"> * levels are less likely to be returned. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">zslRandomLevel</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 其中</span></span><br><span class="line">    <span class="comment">// #define ZSKIPLIST_P 0.25</span></span><br><span class="line">    <span class="comment">// The largest number rand will return (same as INT_MAX).</span></span><br><span class="line">    <span class="comment">// #define	RAND_MAX	2147483647</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> threshold = ZSKIPLIST_P*RAND_MAX;</span><br><span class="line">    <span class="type">int</span> level = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (random() &lt; threshold)</span><br><span class="line">        level += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，每次有0.25的概率增加到新的一层。<br>如果为了维护索引结构，需要很多变量记录跳表的状态，每次计算level，显得复杂。因为这里对索引结点的要求并不严苛，所以这里用概率的方式，巧妙地确定了新结点的层数。规避了复杂的结构，也利于代码的维护。</p>
<p>熟悉了insert的代码，查找和删除的代码也就非常容易写出了。为此，请仿照redis的写法，完成练习：</p>
<p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/design-skiplist">leetcode 1206 设计跳表</a></p>
<h2 id="listpack-和-skiplist-比较"><a href="#listpack-和-skiplist-比较" class="headerlink" title="listpack 和 skiplist 比较"></a>listpack 和 skiplist 比较</h2><p>listpack，ziplist的介绍见本站另一篇文章</p>
<p>回答刚开始提出的问题：</p>
<p> <strong>对于zset有序集合结构，为什么在key较少且value较短的情况下，使用listpack，而当key较多或者value较长的情况下，转而使用skiplist</strong> ?</p>
<p>首先列表比较分析时空复杂度.</p>
<p>注意这里比较的是对 <strong>有序集合</strong> 的维护，需要 <strong>保序</strong> 。对于list,set等不需要排序的类型，listpack 不需要O(N) 遍历。</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>listpack 时间复杂度</th>
<th>skiplist 时间复杂度</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>插入</strong></td>
<td>O(N)</td>
<td>O(log N)</td>
<td>listpack 需要线性遍历找到插入位置；skiplist 通过跳跃层高效定位插入位置。</td>
</tr>
<tr>
<td><strong>删除</strong></td>
<td>O(N)</td>
<td>O(log N)</td>
<td>listpack 需要线性查找删除元素；skiplist 通过跳跃层快速查找并删除元素。</td>
</tr>
<tr>
<td><strong>查找</strong></td>
<td>O(N)</td>
<td>O(log N)</td>
<td>listpack 通过线性扫描查找元素；skiplist 通过多层结构快速查找。</td>
</tr>
<tr>
<td><strong>更新</strong></td>
<td>O(N)</td>
<td>O(log N)</td>
<td>listpack 需要线性查找目标元素然后更新；skiplist 可以高效查找并更新元素。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>数据结构</th>
<th>空间复杂度</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>listpack</strong></td>
<td>O(N)</td>
<td>listpack 是一种紧凑的数据结构，只存储数据本身和少量的元数据。</td>
</tr>
<tr>
<td><strong>skiplist</strong></td>
<td>O(N)</td>
<td>skiplist 使用多层链表结构，每层增加的指针会带来额外的空间开销。</td>
</tr>
</tbody></table>
<p>既然skiplist的时间复杂度好于listpack，那为什么zset在数据量较小时，还要使用listpack?</p>
<p>参考回答：</p>
<ul>
<li><p>空间效率：listpack 是一种紧凑的数据结构，旨在节省内存。它将多个元素压缩存储在一个连续的内存块中，减少了元数据（如指针、跨度等）的开销。因此，当数据量较小或每个元素的数据较小时，listpack 可以显著减少内存占用。</p>
</li>
<li><p>实际性能：尽管 skiplist 在大数据集上的时间复杂度更优，但在小数据集上的性能优势并不明显，反而会因为维护多个层级的链表结构和指针带来的额外开销，使得性能有所下降。而 listpack 由于其紧凑的结构，数据可以集中存储在内存的一个小区域内，这样会提升 CPU 缓存的命中率，从而在小数据集上表现出更好的实际性能。</p>
</li>
<li><p>复杂度的权衡：对于 Redis 来说，简单的操作和低内存占用是非常重要的。当数据量较小时，操作的绝对时间可能不会因为算法的复杂度降低多少，所以此时节省空间会成为优先考虑的因素。</p>
</li>
<li><p>总的来说，listpack 在数据较小时通过优化内存使用和缓存性能，提供了更好的整体表现，而当数据量增大到一定程度后，skiplist 的时间复杂度优势才会变得显著，此时 Redis 会自动切换到 skiplist</p>
</li>
</ul>
<p>实际上可以参考HashMap 链表-红黑树的转换的原因。</p>
<h2 id="跳表-和-B-tree-rb-tree-比较"><a href="#跳表-和-B-tree-rb-tree-比较" class="headerlink" title="跳表 和 B+ tree&#x2F;rb-tree 比较"></a>跳表 和 B+ tree&#x2F;rb-tree 比较</h2><p>javaguide上有详细说明</p>
<p><a target="_blank" rel="noopener" href="https://javaguide.cn/database/redis/redis-skiplist.html#b-%E6%A0%91-vs-%E8%B7%B3%E8%A1%A8">https://javaguide.cn/database/redis/redis-skiplist.html#b-%E6%A0%91-vs-%E8%B7%B3%E8%A1%A8</a></p>
<h1 id="面试题参考"><a href="#面试题参考" class="headerlink" title="面试题参考"></a>面试题参考</h1><p>redis 数据结构 相关面试题总结<br>个人回答仅供参考，请自行组织语言回答</p>
<blockquote>
<p>1、redis 有哪些数据结构?</p>
</blockquote>
<p>基本类型有string, list, hash, set, zet<br>其中string 就是字符串，最常用；list是双向链表，hash是哈希类型，常用来存储对象；set 是集合类型，存储不重复的元素；zset是有序集合</p>
<p>三种特殊类型：</p>
<p>bitmap(0-1位图，节省空间，保存0&#x2F;1状态的信息)</p>
<p>HyperLogLog(基数统计，通过一定的概率统计方法预估基数值（集合中包含元素的个数，存在误差，适用于热门网站每日&#x2F;每周&#x2F;每月访问 ip 数统计、热门帖子 uv 统计))</p>
<p>Geospatial(存储地理位置，基于sorted set，保存经纬度，计算距离等)</p>
<blockquote>
<p>2、各种类型的内部实现&#x2F;(zset)内部用了什么数据结构</p>
</blockquote>
<p>String: sds(Simple Dynamic String)<br>List: Listpack - quicklist(双向链表，数据量大，多个listpack连接而成)<br>Hash: Dict, ListPack<br>Set: intset, hashtable<br>Zset: ListPack - SkipList（数据量大）</p>
<p>zset用了listpack和skiplist。(redis7.4)</p>
<p>早期会用到ziplist压缩链表，但现在用listpack代替。在元素个数少，且value长度小的情况下，先使用listpack类型，当数量和长度达到一定的阈值，转变为使用skiplist，也就是跳表。在添加和删除元素时，会判断是否达到阈值，从而进行可能的内置内心转换。实际上和Java的HashMap的链表-红黑树转换类似。在不同的条件下使用不同的内置数据结构。</p>
<blockquote>
<p>3、zset的底层为什么需要这么设计(问2可以接着回答)</p>
</blockquote>
<p>listpack就是修改后的ziplist，相比跳表更节省空间，实现简单，使用连续的内存区域，cache命中率高。但是，由于需要维护的数据结构是有序的表，需要保序。因此实际上listpack的增删改查时间复杂度的O(N)， 而跳表是O(logN)，在结点数量很多时优势比较明显。缺陷在于，相比简单的listpack，需要额外的结点，稍浪费内存。</p>
<blockquote>
<p>4、ziplist 有什么问题</p>
</blockquote>
<p>ziplist极致节省空间，会带来问题，主要是连锁更新问题。虽然用了链表的思想，但实际上并不是普通的链表那样有用显示的prev和next来指向前后结点，而是通过字节偏移量来确认。为了提高空间利用率和cache命中率，采用一段连续的空间存储。而为了正确读取数据，需要一个协议来划分结点。也就是一个字段保存长度。ziplist有一个字段保存的是上一个结点的大小。而这个字段本身可能变化：2^8 &#x3D; 256, 因此1字节可以记录255字节以内的长度。一旦超过这个长度，就会扩展为5字节，也就是多出4字节。有一种特殊的情况，一系列的结点大小均为253，此时一个结点变成了257字节，超过了255，1字节无法表示，下一个结点的prevlen变成5字节，那么下一节点就变成了257字节，也超过了255，需要再次遍历。最坏情况需要遍历整个链表，非常耗时，而redis常用来处理频繁，热点数据，对时间性能要求很高，显然不能满足。那为什么一开始不多设计几个字节存储长度，因为绝大多数情况下，存放的key和value都比较小，255字节已经足够使用。另外，这样的极端情况其实也非常少见。</p>
<blockquote>
<p>5、跳表这么好用，为什么MySQL索引采用B+树的方式，而不是跳表</p>
</blockquote>
<p>此题为笔者大三找实习时，一道面试原题，当时无从作答。</p>
<p>需求不一样。MySQL innodb 的索引，能够减少访问磁盘的次数。访问一次索引就相当于访问一次磁盘。而MySQL innodb的索引，实际上最后只需要三层左右，就能覆盖大量的数据(4300w)。而跳表的层数如果太低，一个区间内遍历的次数太长，如果太高，一共需要访问的索引结点数量太多，这都和减少IO次数的初衷不符合。另外，数据库要求存放大量的数据，要求相对稳定的存储结构，要求较高较稳定的效率。跳表依赖一个概率，结构不是很稳定。而redis往往用来当缓存，而且是全部内存操作，没有这些需求。内存的读写效率是远高于磁盘读写的。因此数据库层面采用B+树更合理。</p>
<p>而相比B+树，跳表实现简单，易于调试，实现简单，可以调节概率，更加节省内存。B+树涉及结点分裂，合并，结构稳定，但是实现调试起来比较困难。</p>
<p>另外，有序集合经常是许多 ZRANGE 或 ZREVRANGE 操作的目标，也就是说，以链表的方式遍历跳表。通过这种操作，跳表的缓存局部性至少和其他类型的平衡树一样好</p>
<blockquote>
<p>6、为什么用跳表不用红黑树</p>
</blockquote>
<p>对于区间查询，跳表效率更高，且实现更简单。redis在读多写少的场景下，性能优势更明显。</p>
<p>HashMap 优化用红黑树不用跳表，因为红黑树的优势在于，最坏情况下的crud复杂度也是log(n)， 而跳表性能不够稳定，由于概率的原因，最坏情况可能接近O(n),这在数据量大的时候相对劣势。另外，红黑树比跳表省内存，并且其实现已成熟且被广泛应用。另外保持与TreeMap结构的一致性。</p>
<blockquote>
<p>7、List内部的数据结构&#x2F;quicklist</p>
</blockquote>
<p>内部是快速链表quicklist，quicklist实际上是多个listpack的拼接。整体相当于一个双向链表，每个结点代表一个listpack元素。因为单个listpack，在数据量比较大的情况下，可能带来问题：频繁移动整个链表数据，延迟，单点故障，内存分配失败等。通过quicklist则更灵活，可以快速定位listpack，缩小查找范围，提高效率。</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p>redis源码：<a target="_blank" rel="noopener" href="https://github.com/redis/redis/releases">https://github.com/redis/redis/releases</a></p>
<p>知乎 ziplist：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/426009915">https://zhuanlan.zhihu.com/p/426009915</a></p>
<p>javaguide redis-skiplist：<a target="_blank" rel="noopener" href="https://javaguide.cn/database/redis/redis-skiplist.html">https://javaguide.cn/database/redis/redis-skiplist.html</a></p>
<p>小林 redis-data_struct：<a target="_blank" rel="noopener" href="https://www.xiaolincoding.com/redis/data_struct">https://www.xiaolincoding.com/redis/data_struct</a></p>
<p>leetcode 1206 设计跳表：<a target="_blank" rel="noopener" href="https://leetcode.cn/problems/design-skiplist">https://leetcode.cn/problems/design-skiplist</a></p>
<h1 id="附录-leetcode-1206-参考实现"><a href="#附录-leetcode-1206-参考实现" class="headerlink" title="附录 leetcode 1206 参考实现"></a>附录 leetcode 1206 参考实现</h1><p>时空双 90+%</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Skiplist</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_LEVEL</span> <span class="operator">=</span> <span class="number">32</span>;  <span class="comment">// Skiplist 的最大层数</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">double</span> <span class="variable">p</span> <span class="operator">=</span> <span class="number">0.25</span>;     <span class="comment">// 控制新节点增加层数的概率</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxLevel</span> <span class="operator">=</span> <span class="number">1</span>;  <span class="comment">// 当前的最大层数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Node</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Integer.MIN_VALUE, MAX_LEVEL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        <span class="type">int</span> value;</span><br><span class="line">        Node[] next; <span class="comment">// next[i] 表示i层下的next</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(<span class="type">int</span> value, <span class="type">int</span> level)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.next = <span class="keyword">new</span> <span class="title class_">Node</span>[level + <span class="number">1</span>]; <span class="comment">// 从第一层开始算</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">randomLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (; level &lt; MAX_LEVEL; level++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Math.random() &gt; p) &#123;</span><br><span class="line">                <span class="keyword">return</span> level;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定level下，最接近target ( &lt; target ) 的 前一个 node</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">find</span><span class="params">(Node node, <span class="type">int</span> level, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node;</span><br><span class="line">        <span class="keyword">while</span>(p.next[level] != <span class="literal">null</span> &amp;&amp; p.next[level].value &lt; target) &#123;</span><br><span class="line">            p = p.next[level];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Skiplist</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">search</span><span class="params">(<span class="type">int</span> target)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> maxLevel;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">while</span>(level &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            node = find(node, level, target);    </span><br><span class="line">            <span class="keyword">if</span> (node.next[level] != <span class="literal">null</span> &amp;&amp;  node.next[level].value == target) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            level--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ranLevel</span> <span class="operator">=</span> randomLevel();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(num, ranLevel); </span><br><span class="line">        <span class="type">Node</span> <span class="variable">prev</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// 从最高层往下add</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> maxLevel; level &gt;= <span class="number">1</span>; level--) &#123;</span><br><span class="line">            prev = find(prev, level, num);</span><br><span class="line">            <span class="keyword">if</span> (level &lt;= ranLevel) &#123;</span><br><span class="line">                node.next[level] = prev.next[level];</span><br><span class="line">                prev.next[level] = node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ranLevel &gt; maxLevel) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> maxLevel + <span class="number">1</span>; i &lt;= ranLevel; i++) &#123;</span><br><span class="line">                head.next[i] = node;</span><br><span class="line">            &#125;</span><br><span class="line">            maxLevel = ranLevel;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">erase</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="comment">// 从高层往下删除</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> maxLevel; level &gt;= <span class="number">1</span>; level--) &#123;</span><br><span class="line">            node = find(node, level, num);</span><br><span class="line">            <span class="keyword">if</span> (node.next[level] != <span class="literal">null</span> &amp;&amp; node.next[level].value == num) &#123;</span><br><span class="line">                node.next[level] = node.next[level].next[level];</span><br><span class="line">                ret = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your Skiplist object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * Skiplist obj = new Skiplist();</span></span><br><span class="line"><span class="comment"> * boolean param_1 = obj.search(target);</span></span><br><span class="line"><span class="comment"> * obj.add(num);</span></span><br><span class="line"><span class="comment"> * boolean param_3 = obj.erase(num);</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://jinglong-liu.github.io">liujinglong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://jinglong-liu.github.io/2024/09/08/skiplist/">https://jinglong-liu.github.io/2024/09/08/skiplist/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jinglong-liu.github.io" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/redis/">redis</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/08/redis-listpack/" title="listpack, ziplist, quicklist"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">listpack, ziplist, quicklist</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/20/spring-transaction-propagation/" title="spring 事务传播机制"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">spring 事务传播机制</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/09/08/redis-listpack/" title="listpack, ziplist, quicklist"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-08</div><div class="title">listpack, ziplist, quicklist</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">liujinglong</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">redis 调试环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81"><span class="toc-number">2.1.</span> <span class="toc-text">下载源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91"><span class="toc-number">2.2.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vscode-%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.</span> <span class="toc-text">vscode 调试环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh"><span class="toc-number">2.3.1.</span> <span class="toc-text">ssh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AElaunch-%E5%92%8C-tasks"><span class="toc-number">2.3.2.</span> <span class="toc-text">配置launch 和 tasks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-server-%E5%90%AF%E5%8A%A8"><span class="toc-number">2.3.3.</span> <span class="toc-text">redis-server 启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-client-%E5%90%AF%E5%8A%A8"><span class="toc-number">2.3.4.</span> <span class="toc-text">redis-client 启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-zset"><span class="toc-number">3.</span> <span class="toc-text">redis zset</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#zset-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%8E%A2%E7%B4%A2"><span class="toc-number">3.1.</span> <span class="toc-text">zset 数据结构探索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#skiplist"><span class="toc-number">3.2.</span> <span class="toc-text">skiplist</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#skiplist%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.1.</span> <span class="toc-text">skiplist数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#insert"><span class="toc-number">3.2.2.</span> <span class="toc-text">insert</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zslRandomLevel"><span class="toc-number">3.2.3.</span> <span class="toc-text">zslRandomLevel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#listpack-%E5%92%8C-skiplist-%E6%AF%94%E8%BE%83"><span class="toc-number">3.3.</span> <span class="toc-text">listpack 和 skiplist 比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%B3%E8%A1%A8-%E5%92%8C-B-tree-rb-tree-%E6%AF%94%E8%BE%83"><span class="toc-number">3.4.</span> <span class="toc-text">跳表 和 B+ tree&#x2F;rb-tree 比较</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">面试题参考</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">5.</span> <span class="toc-text">参考文献</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95-leetcode-1206-%E5%8F%82%E8%80%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">附录 leetcode 1206 参考实现</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/06/juc-jmm/" title="Java 内存模型 (JMM)">Java 内存模型 (JMM)</a><time datetime="2024-10-06T00:50:17.000Z" title="发表于 2024-10-06 08:50:17">2024-10-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/20/jvm-gc-1/" title="JVM 源码分析 - 垃圾回收（一）">JVM 源码分析 - 垃圾回收（一）</a><time datetime="2024-09-20T01:36:31.000Z" title="发表于 2024-09-20 09:36:31">2024-09-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/18/asehw-1/" title="无题">无题</a><time datetime="2024-09-18T10:49:38.048Z" title="发表于 2024-09-18 18:49:38">2024-09-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/14/jerry-mouse-0/" title="手写Tomcat 0:准备工作">手写Tomcat 0:准备工作</a><time datetime="2024-09-14T00:05:33.000Z" title="发表于 2024-09-14 08:05:33">2024-09-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/10/build-open-jdk/" title="build-open-jdk">build-open-jdk</a><time datetime="2024-09-10T04:38:55.000Z" title="发表于 2024-09-10 12:38:55">2024-09-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By liujinglong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.14.0-b2"></script><script src="/js/main.js?v=4.14.0-b2"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.innerHTML = `<pre class="mermaid-src" hidden>${ele.textContent}</pre>`
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '4JE6J6Fimc9mBF9PTJvsX6P2-gzGzoHsz',
      appKey: '0F61JyHXoFJLYMGMy6p9aZhN',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>